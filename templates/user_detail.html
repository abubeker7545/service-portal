{% extends "base.html" %}
{% block body %}
<div class="card" style="box-shadow:0 8px 24px rgba(56,112,255,0.11);border-radius:18px;padding:34px 28px;max-width:650px;margin:28px auto;">
  <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
    <div style="background:linear-gradient(90deg,#3b82f6 20%,#38bdf8 100%);width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;">
      <span style="font-size:2.7rem;color:#fff;">üë§</span>
    </div>
    <div style="flex:1;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0 0 8px 0;line-height:1;font-weight:900;font-size:2rem;letter-spacing:.01em;color:#1e293b;">
          User #{{ user.id }}
        </h2>
        {% if user.username %}
          <span style="color:#2563eb;font-size:1.06rem;font-weight:700;background:#e0f2fe;padding:2px 12px;border-radius:8px;">
            @{{ user.username }}
          </span>
        {% else %}
          <span style="color:var(--muted);font-style:italic;">No username</span>
        {% endif %}
      </div>
      <div style="color:#64748b;font-size:1rem;margin-bottom:7px;font-family:monospace;">Telegram ID: {{ user.telegram_id }}</div>
      <div style="display:flex;gap:14px;align-items:center;">
        <span style="background:#e0f7ee;color:#059669;padding:4px 12px;border-radius:7px;font-weight:600;font-size:14px;">
          üÜì Free calls: {{ user.free_calls }}
        </span>
        <span style="background:#fff4db;color:#d97706;padding:4px 12px;border-radius:7px;font-size:14px;border:1.2px solid #fde68a;">
          üí≥ Paid calls: {{ user.paid_calls }}
        </span>
      </div>
    </div>
  </div>
  <form method="post" action="{{ url_for('set_quota', user_id=user.id) }}" style="display:flex; align-items:center; gap:10px; margin-top:23px;">
    <label for="quota" style="color:var(--muted);font-size:15px;">Set Free Calls</label>
    <input id="quota" name="free_calls" value="{{user.free_calls}}" type="number"
      style="width:80px;background:#f8fafc;border-radius:9px;border:1.5px solid #e0e7ef;font-size:15px;">
    <button type="submit" style="margin-left:6px;font-weight:700;font-size:15px;padding:9px 23px;border-radius:9px;">
      Update
    </button>
  </form>
  <div style="display:flex;gap:28px;flex-wrap:wrap;margin-top:38px;">
    <div style="flex:1 1 185px;">
      <h3 style="margin-bottom:12px;font-size:1.18rem;letter-spacing:.01em;">üì± Devices</h3>
      {% if devices %}
      <ul style="list-style:none;padding:0;margin:0;">
        {% for d in devices %}
        <li style="background:#f1f5fa;border-radius:8px;padding:8px 14px;margin-bottom:7px;display:flex;align-items:center;">
          <span style="font-family:monospace;color:#2563eb;font-weight:600;">
            {{ d.imei or d.serial }}
          </span>
          {% if d.note %}
          <span style="color:#64748b;margin-left:14px;font-size:14px;">({{ d.note }})</span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
        <div style="color:var(--muted);font-style:italic;margin-left:4px;">No devices found.</div>
      {% endif %}
    </div>
    <div style="flex:2 1 340px;">
      <h3 style="margin-bottom:12px;font-size:1.18rem;letter-spacing:.01em;">üïì Recent Usages</h3>
      <div class="table-wrapper" style="padding:0;background:#f9fbff;">
        <table style="border-radius:13px;overflow:hidden;">
          <thead>
            <tr style="background: #f0f4ff;">
              <th style="font-size:15px;">Date</th>
              <th style="font-size:15px;">Service</th>
              <th style="font-size:15px;">IMEI</th>
              <th style="font-size:15px;">Success</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usages %}
            <tr>
              <td style="white-space:nowrap;font-family:monospace;color:#334155;">
                {{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else "" }}
              </td>
              <td>
                <span style="color:#2563eb;font-weight:600;">{{ u.service.name if u.service else u.service_id }}</span>
              </td>
              <td style="font-family:monospace;">{{ u.imei }}</td>
              <td>
                {% if u.success %}
                  <span style="background:#e0ffe7;color:#059669;padding:2px 13px 2px 10px;border-radius:9px;font-weight:600;">
                    ‚úîÔ∏è
                  </span>
                {% else %}
                  <span style="background:#fce7ee;color:#c026d3;padding:2px 13px 2px 10px;border-radius:9px;font-weight:600;">
                    ‚ùå
                  </span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" style="color:var(--muted);font-style:italic;text-align:center;padding:20px 0;">
                No usage records found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
@media (max-width: 900px) {
  .card > div[style^="display:flex;gap:28px"] {flex-direction: column;}
}
@media (max-width: 650px) {
  .card { padding:18px 6px;}
  .table-wrapper table, .table-wrapper thead, .table-wrapper tbody, .table-wrapper th, .table-wrapper td, .table-wrapper tr {
    display: block;
    width: 100%;
  }
  .table-wrapper thead { display: none; }
  .table-wrapper tr {
    margin-bottom: 16px;
    background: #f8f9fd;
    border-radius: 10px;
    box-shadow: 0 1px 6px rgba(43,80,165,0.06);
    padding: 6px 8px;
    border: 1px solid #e7ecfc;
  }
  .table-wrapper td {
    padding: 8px 7px 8px 40%;
    position: relative;
    min-height:32px;
    border: none;
    border-bottom: 1px solid #f3f6fa;
    font-size:15px;
  }
  .table-wrapper td:before {
    position: absolute;
    left: 13px;
    top: 8px;
    width: 38%;
    white-space: nowrap;
    font-weight: 600;
    color: #2563eb;
    font-size: 13px;
    content: attr(data-label);
  }
  .table-wrapper tr:last-child td {
    border-bottom: none;
  }
}
</style>
<script>
(function() {
  // Add data-label for mobile display
  let ths = Array.from(document.querySelectorAll(".table-wrapper th")).map(th=>th.textContent.trim());
  document.querySelectorAll(".table-wrapper tbody tr").forEach(tr=>{
    tr.querySelectorAll("td").forEach((td, i)=>{
      if(ths[i]) td.setAttribute("data-label", ths[i]);
    });
  });
})();
</script>
{% endblock %}